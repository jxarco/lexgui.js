<script type="module">

    import { LX } from 'lexgui';

    docMaker.header( "Changelog.", "h1", "changelog" );

    docMaker.paragraph( `Latest updates and announcements.` );
    
    {
        const params = new URLSearchParams( document.location.search );
        const content = document.getElementById('content');
        const area = new LX.Area( { skipAppend: true, height: "auto" } );
        const container = LX.makeContainer( ["100%", "auto"], "", "", area );

        const _parseMD = ( text ) => {

            const lines = text.replaceAll("\r\n", "\n").split( "\n" ).slice( 2 );
            let masterVersion = false;
            let currentList = [];

            for( let l = 0; l < lines.length; ++l )
            {
                let line = lines[ l ];

                if( !masterVersion && !(masterVersion = line.includes( "(master)" )) )
                {
                    continue;   
                }

                if( line[ 0 ] == '#' )
                {
                    // its a header
                    const ht = (line.match(/#/g) || []).length;
                    const headerString = line.substring( ht + 3 ).replaceAll( "#", "" );
                    const endIdx = headerString.indexOf( " " );
                    const id = endIdx > -1 ? headerString.substring( 0, endIdx ) : headerString;
                    docMaker.header( headerString, `h${ ht }`, id );
                }
                else
                {
                    let codeIndex = line.indexOf( '`' );

                    while( codeIndex > -1 )
                    {
                        const nextIndex = line.substring( codeIndex + 1 ).indexOf( '`' );
                        const trim = line.substring( codeIndex, codeIndex + nextIndex + 2 );
                        const trimReplaced = docMaker.iCode( trim ).replaceAll( '`', '' );
                        line = line.replace( trim, trimReplaced );
                        codeIndex = line.indexOf( '`' );
                    }

                    if( line == '' )
                    {
                        // I was doing another list
                        if( currentList.length )
                        {
                            // close list
                            docMaker.bulletList( currentList );
                            currentList = [];
                        }

                        const p = lines[ l - 1 ] ?? "",
                                n = lines[ l + 1 ] ?? "";
                        if( p[ 0 ] != "#" && n[ 0 ] != "#" ) docMaker.lineBreak();
                    }
                    else if( line[ 0 ] == '-' )
                    {
                        // I was doing another list
                        if( currentList.length && currentList[ currentList.length - 1 ].constructor === Array )
                        {
                            docMaker.bulletList( currentList );
                            currentList = [];
                        }

                        currentList.push( line.substring( 2 ) );
                    }
                    else if( currentList.length )
                    {
                        if( line[ 0 ] == ' ' )
                        {
                            const updatedLine = line.substring( 4 );
                            if( currentList[ currentList.length - 1 ].constructor === Array )
                            {
                                currentList[ currentList.length - 1 ].push( updatedLine );
                            }
                            else
                            {
                                currentList.push( [] );
                                currentList[ currentList.length - 1 ].push( updatedLine );
                            }
                        }
                        else
                        {
                            // close list
                            docMaker.bulletList( currentList );
                            currentList = [];
                        }
                    }
                    else if( line.length )
                    {
                        docMaker.paragraph( line );
                    }
                }
            }

        };

        LX.requestText( "../changelog.md", ( text ) => {
            _parseMD( text );
        }, (err) => {
            console.error( err );
        } )

        content.appendChild( area.root );
    }

    </script>

</body>